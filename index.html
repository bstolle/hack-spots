<html>
    <head>
        <title>Pokedex</title>
        <meta charset='utf-8'>
        <script type="text/javascript" src='js/jquery.js '></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>
        <script type="text/javascript" src='js/sheetsee.js'></script>
        <link rel="shortcut icon" href="https://raw.github.com/jlord/hack-spots/master/favico.png"/>

        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic'>
        <link media="screen" rel="stylesheet" type="text/css" href="css/style.css">
        <link media="screen" rel="stylesheet" type="text/css" href="css/site.css">
    </head>
<body>
    <div id="wrapper">
        <h1>Pokedex</h1>
        <div class="container">
            <input id="tableFilter" type="text" placeholder="filter by.."></input>
            <span class="noMatches">no matches</span>
            <div id="hackSpotsTable"></div>
        </div>
        <div id="info" class="container">
           <p>footer</p>
           <p id="theNumberofSpots"></p>
    </div><!-- end wrapper -->

    <script id="hackSpotsTable" type="text/html">
        <table>
            <tr>
                <th class="tHeader">Dex No.</th>
                <th class="tHeader">Sprite</th>
                <th class="tHeader">Pokemon</th>
                <th class="tHeader">Types</th>
                <th class="tHeader">Ability</th>
                <th class="tHeader">Nature</th>
                <th class="tHeader">HP</th>
                <th class="tHeader">Atk</th>
                <th class="tHeader">Def</th>
                <th class="tHeader">SpA</th>
                <th class="tHeader">SpD</th>
                <th class="tHeader">Spe</th>
                <th class="tHeader">Moves</th>
                <th class="tHeader">Balls</th>
                <th class="">Elsewhere</th>
            </tr>
            {{#rows}}
                <tr id="{{rowNumber}}" class="spotRow">
                    <td>{{Dex No}}</td>
                    <td><span 
                        class="{{Name}}img"
                        style="repeat scroll 0% 0%; width: 68px; height: 56px; display: inline-block;">
                        <img src="https://raw.githubusercontent.com/msikma/pokesprite/master/pokemon-gen8/regular/{{ImageName}}.png"/>
                    </span></td>
                    <td>{{Name}}</td>
                    <td>{{Form}}</td>
                    <!-- <td>{{sex}}</td> -->
                    <td>{{Ability}}</td>
                    <td>{{Nature}}</td>
                    <td>{{HP IV}}</td>
                    <td>{{Atk IV}}</td>
                    <td>{{Def IV}}</td>
                    <td>{{SpA IV}}</td>
                    <td>{{SpD IV}}</td>
                    <td>{{Spe IV}}</td>
                    <td>{{Move 1}}, {{Move 2}}, {{Move 3}}, {{Move 4}}</td>
                    <td>{{Ball}}</td>
                    <td><a class="button" href="https://maps.google.com/maps?q={{form}},{{Sex}},{{amount}}"
                            target="_blank">G Map</a> <a class="button"
                            href="http://www.yelp.com/search?find_desc={{name}}&find_loc={{Sex}},{{amount}}"
                            target="_blank">Yelp</a></td>
                </tr>
            {{/rows}}
        </table>
    </script>

    <script id="latestSpot" type="text/html">
        {{#rows}}
            <h4 class="fauxButton">MOST RECENT SPOT</h4>
            <h2>{{Name}}</h2>
            <p class="colorText">{{form}}<p>
            <p class="colorText">{{ability}}{{#amount}}, {{amount}}{{/amount}}{{#nature}}, {{nature}}{{/nature}}</p>
            <ul>
                <li><span class="category">Wifi:</span> {{wifipassword}}</li>
                <li><span class="category">Outlets:</span> {{outlets}}</li>
                <li><span class="category">Couch:</span> {{couch}}</li>
                <li><span class="category">Large Table:</span> {{largetable}}</li>
                <li><span class="category">Outdoor Seating:</span> {{outdoorseating}}</li>
                <li><span class="category">Brewing:</span> {{brewing}}</li>
                <li><span class="category">Contributed By:</span> <a href="http://www.twitter.com/{{contributerstwitter}}" target="_blank">@{{contributerstwitter}}</a></li>
            </ul>
            <ul>
                <li><a href="" target="_blank">View in Google Maps</a></li>
                <li><a href="" target="_blank">Find on Yelp</a></li>
            </ul>
        {{/rows}}
    </script>

    <script id="theNumberofSpots" type="text/html">
        <p><strong><span class="red-text">{{numberOfSpots}}</span> pokemon!</p>
    </script>

    <script id="selectedSpot" type="text/html">
        {{#rows}}
            <h4 class="fauxButton">SELECTED SPOT</h4>
            <h2>{{name}}</h2>
            <p class="colorText">{{form}}<p>
            <p class="colorText">{{ability}}{{#amount}}, {{amount}}{{/amount}}{{#nature}}, {{nature}}{{/nature}}</p>
            <ul>
                <li><span class="category">Wifi:</span> {{wifipassword}}</li>
                <li><span class="category">Outlets:</span> {{outlets}}</li>
                <li><span class="category">Couch:</span> {{couch}}</li>
                <li><span class="category">Large Table:</span> {{largetable}}</li>
                <li><span class="category">Outdoor Seating:</span> {{outdoorseating}}</li>
                <li><span class="category">Brewing:</span> {{brewing}}</li>
            </ul>
            <ul>
                <li><a href="" target="_blank">View in Google Maps</a></li>
                <li><a href="" target="_blank">Find on Yelp</a></li>
            </ul>
        {{/rows}}
    </script>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            //var gData
           // var URL = "1j9zYY17BV6hOZ5BElP3Yj3P64si6oaq6kI9syep-Buw" //Google Sheets ID
            var URL = "1RSXuh7-WU8ZA3lU6e143WT0sws5upz_R0j-wncTdL0I"
                Tabletop.init({ key: URL, callback: showInfo, simpleSheet: false })
                //var taco = Tabletop.sheets("DB");
                //console.log(tableOptions.data);
        }) 
        // so long, so messy
        function showInfo(data, tabletop) {
            console.log(tabletop.sheets("Living Dex"));
           // $.each(data, function( index, value ) {
                //value["ImageName"] = value.Name.toLowerCase();
                //console.log(value.ImageName);  
            //});
            var currentSheet = tabletop.sheets("Living Dex").all();
             $.each(currentSheet, function( index, value ) {
                var imageName = value.Name.split(' ').join('-');
                imageName = imageName.replace("'", "");
                imageName = imageName.replace(".", "");
                imageName = imageName.replace(":", "");
                value["ImageName"] = imageName.toLowerCase();
            });
             tableOptions = {
                 "data": currentSheet,
                 "tableDiv": "#hackSpotsTable",
                 "filterDiv": "#tableFilter"
             }
            // make the table, and the search bar
            Sheetsee.makeTable(tableOptions)
            Sheetsee.initiateTableFilter(tableOptions)
            // create geoJSON with coordinates and other
            // useful bits from the original data
            //var optionsJSON = ["Name", "Form", "Sex", "rowNumber"]
            //var geoJSON = Sheetsee.createGeoJSON(data, optionsJSON)
            //var pokename = data[2].name;
            //pokename = pokename.toLowerCase();
            //console.log(pokename)//.toLowerCase());
            //console.log(geoJSON);
            // find the latest spot with the most important
            // info filled in (to prevent map breaking if
            // someone is currently editing spreadsheet)
            //var theLatestSpot = findLatestCompleteSpot(data)
            // var latestSpot = Sheetsee.ich.latestSpot({
            //     rows: theLatestSpot
            // })

            // when someone clicks on a row, highlight it and
            // re-center the map
            // TODO show popup, change marker color
            // $('.spotRow').live("click", function(event) {
            //     $('.spotRow').removeClass("selectedRow")
            //     var rowNumber = $(this).closest("tr").attr("id")
            //     $('#' + rowNumber).addClass("selectedRow")
            //     var dataElement = Sheetsee.getMatches(data, rowNumber, "rowNumber")
            //     var selectedSpot = Sheetsee.ich.selectedSpot({
            //         rows: dataElement
            //     })
            //     $('#latestSpot').css("display", "none")
            //     $('#selectedSpot').html(selectedSpot).css("display", "inline")
            // })

            // so that the first map and info that loads
            // is complete and doesn't show rows that are
            // actively being edited by folk
            // function findLatestCompleteSpot(data) {
            //     var latestCompleteSpot = []
            //     var startWithLatestRow = data.reverse()
            //     startWithLatestRow.forEach(function(row){
            //         if (!row.lat || !row.long || !row.name || !row.form || !row.sex || !row.amount ) return
            //         else latestCompleteSpot.push(row)
            //     })
            //     return latestCompleteSpot[0]
            // }

            // find total number of spots added
            var theNumberofSpots = Sheetsee.ich.theNumberofSpots({
                numberOfSpots: currentSheet.length
            })
            $('#theNumberofSpots').html(theNumberofSpots)

            if(window.location.hash) {
                $('#tableFilter').val(window.location.hash.substring(1)).keyup()
                $('.spotRow').first().click()
            }
        }

        $(document).on('keyup', '#tableFilter', function() {
            window.location.hash = $(this).val()
            $('.spotRow').first().click()
        })
    </script>
</body>
</html>
